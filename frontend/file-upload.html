<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Upload - AI.Tech</title>
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Ubuntu:wght@500;700&display=swap"
        rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="lib/animate/animate.min.css" rel="stylesheet">
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <style>
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            position: relative;
            background-color: #ffffff;
        }
        
        .upload-area.highlight {
            border-color: var(--primary);
            background-color: rgba(102, 126, 234, 0.05);
        }
        
        .file-input {
            display: none;
        }
        
        .file-list {
            margin-top: 20px;
            text-align: left;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            background-color: #ffffff;
        }
        
        .file-name {
            flex-grow: 1;
            margin-right: 10px;
            word-break: break-all;
        }
        
        .file-size {
            color: #6c757d;
            font-size: 0.9em;
            margin-right: 15px;
            white-space: nowrap;
        }
        
        .progress-container {
            width: 100%;
            height: 8px;
            background-color: #f5f5f5;
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
            display: none;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .uploads-section {
            margin-top: 30px;
        }
        
        .uploaded-files {
            margin-top: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            background-color: #ffffff;
        }
        
        .uploaded-file-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .uploaded-file-item:last-child {
            border-bottom: none;
        }
        
        .file-link {
            color: var(--primary);
            text-decoration: none;
            word-break: break-all;
        }
        
        .file-link:hover {
            text-decoration: underline;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary);
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .debug-info {
            margin-top: 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
            white-space: pre-wrap;
            display: none;
        }

        .main-content {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.15);
        }

        .email-chip {
            display: inline-block;
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <!-- Spinner Start -->
    <div id="spinner"
        class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div class="spinner-grow text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
    <!-- Spinner End -->

    <!-- Navbar Start -->
    <div class="container-fluid sticky-top">
    <div class="container">
            <nav class="navbar navbar-expand-lg navbar-dark p-0">
                <a href="index.html" class="navbar-brand">
                    <h1 class="text-white">AI<span class="text-dark">.</span>Tech</h1>
                </a>
                <button type="button" class="navbar-toggler ms-auto me-0" data-bs-toggle="collapse"
                    data-bs-target="#navbarCollapse">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <div class="navbar-nav ms-auto">
                        <a href="index.html" class="nav-item nav-link">Home</a>
                        <a href="about.html" class="nav-item nav-link">About</a>
                        <a href="service.html" class="nav-item nav-link">Services</a>
                        <a href="project.html" class="nav-item nav-link">Projects</a>
                        <a href="dashboard.html" class="nav-item nav-link active">Dashboard</a>
                        <div class="nav-item dropdown">
                            <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">Pages</a>
                            <div class="dropdown-menu bg-light mt-2">
                                <a href="feature.html" class="dropdown-item">Features</a>
                                <a href="team.html" class="dropdown-item">Our Team</a>
                                <a href="faq.html" class="dropdown-item">FAQs</a>
                                <a href="testimonial.html" class="dropdown-item">Testimonial</a>
                                <a href="404.html" class="dropdown-item">404 Page</a>
                            </div>
                        </div>
                        <a href="contact.html" class="nav-item nav-link">Contact</a>
                    </div>
                    <button type="button" class="btn text-white p-0 d-none d-lg-block" data-bs-toggle="modal"
                        data-bs-target="#searchModal"><i class="fa fa-search"></i></button>
                </div>
            </nav>
        </div>
    </div>
    <!-- Navbar End -->

    <!-- Hero Start -->
    <div class="container-fluid pt-5 bg-primary hero-header mb-5">
        <div class="container pt-5">
            <div class="row g-5 pt-5">
                <div class="col-lg-6 align-self-center text-center text-lg-start mb-lg-5">
                    <div class="btn btn-sm border rounded-pill text-white px-3 mb-3 animated slideInRight">File Manager</div>
                    <h1 class="display-4 text-white mb-4 animated slideInRight">Document Upload</h1>
                    <p class="text-white mb-4 animated slideInRight">Securely upload and manage your documents in our cloud storage. Share files with team members and access your documents from anywhere.</p>
                </div>
                <div class="col-lg-6 align-self-end text-center text-lg-end">
                    <img class="img-fluid" src="img/hero-img.png" alt="">
                </div>
            </div>
        </div>
    </div>
    <!-- Hero End -->

    <!-- Full Screen Search Start -->
    <div class="modal fade" id="searchModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content" style="background: rgba(20, 24, 62, 0.7);">
                <div class="modal-header border-0">
                    <button type="button" class="btn btn-square bg-white btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body d-flex align-items-center justify-content-center">
                    <div class="input-group" style="max-width: 600px;">
                        <input type="text" class="form-control bg-transparent border-light p-3"
                            placeholder="Type search keyword">
                        <button class="btn btn-light px-4"><i class="bi bi-search"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Full Screen Search End -->

    <!-- Main Content Start -->
    <div class="container-fluid py-5">
        <div class="container">
            <div class="row g-5">
                <div class="col-lg-12 wow fadeIn" data-wow-delay="0.5s">
                    <div class="main-content">
                        <div class="alert alert-success" id="successAlert" style="display: none;"></div>
                        <div class="alert alert-danger" id="errorAlert" style="display: none;"></div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="projectSelect" class="form-label fw-bold">Select Project:</label>
                                    <select id="projectSelect" class="form-select rounded-pill">
                <option value="project-1">Project 1</option>
                <option value="project-2">Project 2</option>
                <option value="project-3">Project 3</option>
            </select>
                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="accessEmails" class="form-label fw-bold">Grant Access To (Emails):</label>
                                    <div class="input-group">
                                        <input type="email" id="accessEmails" class="form-control rounded-pill rounded-end-0" placeholder="Enter email addresses (comma-separated)">
                                        <button class="btn btn-primary rounded-pill rounded-start-0" id="addEmailBtn">Add Email</button>
                                    </div>
                                    <div id="emailList" class="mt-2"></div>
                                </div>
            </div>
        </div>
        
                        <div class="upload-area rounded-3 wow fadeIn" id="uploadArea" data-wow-delay="0.3s">
                            <div class="mb-4">
                                <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                            </div>
                            <h4 class="mb-3">Drag and drop files here or click to select files</h4>
                            <p class="text-muted mb-4">Supported formats: PDF, DOC, DOCX, XLS, XLSX, TXT, JPG, PNG, GIF</p>
                            <button class="btn btn-primary rounded-pill px-4" id="selectFileBtn">Select Files</button>
            <input type="file" class="file-input" id="fileInput" multiple>
        </div>
        
                        <div id="fileList" class="file-list rounded-3 p-3 bg-light"></div>
                        
                        <div class="text-center mt-4">
                            <button class="btn btn-primary rounded-pill px-4 me-2" id="uploadBtn" disabled>Upload Files</button>
                            <button class="btn btn-outline-primary rounded-pill px-4" id="clearBtn" disabled>Clear Files</button>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processing your files...</p>
        </div>
        
                        <div class="uploads-section mt-5">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2 class="m-0">Your Uploaded Documents</h2>
                            </div>
                            <div class="uploaded-files rounded-3" id="uploadedFiles">
                                <p class="p-3 text-muted">No uploaded documents yet</p>
            </div>
        </div>
        
                        <!-- Grant Access to Existing Files Section -->
                        <div class="mt-5">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h3 class="m-0">Grant Access to Existing Files</h3>
                            </div>
                            <div class="p-3 bg-light rounded-3">
                                <div class="row g-3">
                                    <div class="col-md-5">
                                        <label for="existingProjectSelect" class="form-label">Select Project:</label>
                                        <select id="existingProjectSelect" class="form-select rounded-pill">
                                            <option value="project-1">Project 1</option>
                                            <option value="project-2">Project 2</option>
                                            <option value="project-3">Project 3</option>
                                        </select>
                                    </div>
                                    <div class="col-md-5">
                                        <label for="existingFileSelect" class="form-label">Select File:</label>
                                        <select id="existingFileSelect" class="form-select rounded-pill">
                                            <option value="">Select a project first</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button class="btn btn-primary rounded-pill w-100" id="loadFilesBtn">Load Files</button>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <label for="grantAccessEmails" class="form-label">Grant Access To (Emails):</label>
                                    <div class="input-group">
                                        <input type="email" id="grantAccessEmails" class="form-control rounded-pill rounded-end-0" 
                                            placeholder="Enter email addresses (comma-separated)">
                                        <button class="btn btn-primary rounded-pill rounded-start-0" id="addGrantEmailBtn">Add Email</button>
                                    </div>
                                    <div id="grantEmailList" class="mt-2"></div>
                                </div>
                                
                                <div class="text-center mt-3">
                                    <button class="btn btn-primary rounded-pill px-4" id="updateAccessBtn" disabled>Update Access</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="debug-section mt-4 text-center">
                            <button class="btn btn-outline-secondary rounded-pill px-4" id="toggleDebugBtn">Toggle Debug Info</button>
            <div class="debug-info" id="debugInfo"></div>
        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Main Content End -->

    <!-- Upload Method Options Section -->
    <div class="container-fluid bg-light py-4">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 wow fadeIn" data-wow-delay="0.5s">
                    <div class="main-content">
                        <h3 class="text-primary mb-4">Upload Methods</h3>
                        <p class="mb-3">Choose an upload method to work around CORS issues:</p>
                        
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="uploadMethod" id="base64UploadRadio" checked>
                                    <label class="form-check-label" for="base64UploadRadio">
                                        Base64 Upload (Most Compatible)
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="uploadMethod" id="directUploadRadio">
                                    <label class="form-check-label" for="directUploadRadio">
                                        Direct Upload (REST API)
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="uploadMethod" id="sdkUploadRadio">
                                    <label class="form-check-label" for="sdkUploadRadio">
                                        SDK Upload (Requires CORS Config)
                                    </label>
                                </div>
        </div>
    </div>
                        
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Base64 Upload:</strong> Converts files to base64 and stores in Firestore, completely avoiding CORS issues with Storage.
                        </div>
                        
                        <div class="alert alert-primary">
                            <i class="fas fa-lightbulb me-2"></i>
                            <strong>Note:</strong> Base64 method stores files in Firestore database rather than Storage bucket, ideal for smaller files (< 10MB).
                        </div>
                        
                        <div class="mt-4">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="useEmulatorCheckbox">
                                <label class="form-check-label" for="useEmulatorCheckbox">
                                    Use Firebase Local Emulator
                                </label>
                            </div>
                            <div id="emulatorSettings" class="row g-3" style="display: none;">
                                <div class="col-md-6">
                                    <input type="text" id="emulatorHost" class="form-control rounded-pill" placeholder="Host (default: localhost)">
                                </div>
                                <div class="col-md-6">
                                    <input type="text" id="emulatorPort" class="form-control rounded-pill" placeholder="Port (default: 9199)">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <button class="btn btn-primary rounded-pill px-4" id="checkCollectionsBtn">Check Firestore Collections</button>
                            <button class="btn btn-success rounded-pill px-4 ms-2" id="doneBtn">Done</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div>
    </div>

    <!-- Footer Start -->
    <div class="container-fluid bg-dark text-white-50 footer pt-5">
        <div class="container py-5">
            <div class="row g-5">
                <div class="col-md-6 col-lg-3 wow fadeIn" data-wow-delay="0.1s">
                    <a href="index.html" class="d-inline-block mb-3">
                        <h1 class="text-white">AI<span class="text-primary">.</span>Tech</h1>
                    </a>
                    <p class="mb-0">Tempor erat elitr rebum at clita. Diam dolor diam ipsum et tempor sit. Aliqu diam
                        amet diam et eos labore. Clita erat ipsum et lorem et sit, sed stet no labore lorem sit. Sanctus
                        clita duo justo et tempor</p>
                </div>
                <div class="col-md-6 col-lg-3 wow fadeIn" data-wow-delay="0.3s">
                    <h5 class="text-white mb-4">Get In Touch</h5>
                    <p><i class="fa fa-map-marker-alt me-3"></i>123 Street, New York, USA</p>
                    <p><i class="fa fa-phone-alt me-3"></i>+012 345 67890</p>
                    <p><i class="fa fa-envelope me-3"></i>info@example.com</p>
                    <div class="d-flex pt-2">
                        <a class="btn btn-outline-light btn-social" href=""><i class="fab fa-twitter"></i></a>
                        <a class="btn btn-outline-light btn-social" href=""><i class="fab fa-facebook-f"></i></a>
                        <a class="btn btn-outline-light btn-social" href=""><i class="fab fa-youtube"></i></a>
                        <a class="btn btn-outline-light btn-social" href=""><i class="fab fa-instagram"></i></a>
                        <a class="btn btn-outline-light btn-social" href=""><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3 wow fadeIn" data-wow-delay="0.5s">
                    <h5 class="text-white mb-4">Popular Link</h5>
                    <a class="btn btn-link" href="">About Us</a>
                    <a class="btn btn-link" href="">Contact Us</a>
                    <a class="btn btn-link" href="">Privacy Policy</a>
                    <a class="btn btn-link" href="">Terms & Condition</a>
                    <a class="btn btn-link" href="">Career</a>
                </div>
                <div class="col-md-6 col-lg-3 wow fadeIn" data-wow-delay="0.7s">
                    <h5 class="text-white mb-4">Our Services</h5>
                    <a class="btn btn-link" href="">Robotic Automation</a>
                    <a class="btn btn-link" href="">Machine learning</a>
                    <a class="btn btn-link" href="">Predictive Analysis</a>
                    <a class="btn btn-link" href="">Data Science</a>
                    <a class="btn btn-link" href="">Robot Technology</a>
                </div>
            </div>
        </div>
        <div class="container wow fadeIn" data-wow-delay="0.1s">
            <div class="copyright">
                <div class="row">
                    <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                        &copy; <a class="border-bottom" href="#">Your Site Name</a>, All Right Reserved.

                        <!--/*** This template is free as long as you keep the footer author's credit link/attribution link/backlink. If you'd like to use the template without the footer author's credit link/attribution link/backlink, you can purchase the Credit Removal License from "https://htmlcodex.com/credit-removal". Thank you for your support. ***/-->
                        Designed By <a class="border-bottom" href="https://htmlcodex.com">HTML Codex</a>
                    </div>
                    <div class="col-md-6 text-center text-md-end">
                        <div class="footer-menu">
                            <a href="">Home</a>
                            <a href="">Cookies</a>
                            <a href="">Help</a>
                            <a href="">FAQs</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer End -->

    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top pt-2"><i class="bi bi-arrow-up"></i></a>

    <!-- JavaScript Libraries -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="lib/wow/wow.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/counterup/counterup.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script>

    <script>
        // Initialize WOW JS for animations
        new WOW().init();
        
        // Firebase configuration - using the same credentials from your OTP page
        const firebaseConfig = {
            apiKey: "AIzaSyDRfEEw2-zyeN91zli2y5MK4QjY4Om3o6A",
            authDomain: "kjsitalgo.firebaseapp.com",
            projectId: "kjsitalgo",
            storageBucket: "gs://kjsitalgo",
            messagingSenderId: "1003312299685",
            appId: "1:1003312299685:web:ef7e8b416fc7628147174c",
            measurementId: "G-CE7SDSSK7R"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Get storage reference
        const storage = firebase.storage();
        const storageRef = storage.ref();
        // Add this line to initialize auth
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Selected files array
        let selectedFiles = [];
        let uploadTasks = [];
        
        // Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const selectFileBtn = document.getElementById('selectFileBtn');
        const fileList = document.getElementById('fileList');
        const uploadBtn = document.getElementById('uploadBtn');
        const clearBtn = document.getElementById('clearBtn');
        const uploadedFiles = document.getElementById('uploadedFiles');
        const loading = document.getElementById('loading');
        const successAlert = document.getElementById('successAlert');
        const errorAlert = document.getElementById('errorAlert');
        const debugInfo = document.getElementById('debugInfo');
        const toggleDebugBtn = document.getElementById('toggleDebugBtn');
        
        // Log initial debug info
        debugInfo.innerHTML = 'Firebase Project: ' + firebaseConfig.projectId;
        debugInfo.innerHTML += '\nStorage Bucket: ' + firebaseConfig.storageBucket;
        debugInfo.innerHTML += '\nCurrent Domain: ' + window.location.hostname;
        
        // Check if user is logged in
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                debugInfo.innerHTML += '\nUser logged in: ' + user.uid;
                initializeProjects().then(() => {
                    loadUserDocuments(user.uid);
                });
            } else {
                debugInfo.innerHTML += '\nNo user logged in. Using anonymous mode.';
                
                // For demo purposes, we'll allow anonymous uploads
                // In a real app, you might want to redirect to login
                anonymousLogin();
            }
        });
        
        // Anonymous login function for demo
        function anonymousLogin() {
            firebase.auth().signInAnonymously()
                .then((result) => {
                    debugInfo.innerHTML += '\nAnonymous login successful';
                })
                .catch((error) => {
                    debugInfo.innerHTML += '\nAnonymous login error: ' + error.message;
                    showError('Error setting up anonymous session. Please reload the page.');
                });
        }
        
        // Load user's already uploaded files
        async function loadUserDocuments(userId) {
            const user = firebase.auth().currentUser;
            if (!user || !user.email) {
                showError('No user email available. Please sign in with an email account.');
                return;
            }
            
            loading.style.display = 'block';
            debugInfo.innerHTML += '\nFetching documents from Firestore...';
            
            try {
                const db = firebase.firestore();
                const projectsSnapshot = await db.collection('uploadedFiles').get();
                
                loading.style.display = 'none';
                
                if (projectsSnapshot.empty) {
                    uploadedFiles.innerHTML = '<p class="p-3 text-muted">No projects found</p>';
                    return;
                }
                
                uploadedFiles.innerHTML = '';
                let hasFiles = false;
                
                // Process each project
                for (const projectDoc of projectsSnapshot.docs) {
                    const projectData = projectDoc.data();
                    const files = projectData.files || {};
                    const filesList = Object.values(files); // Convert files object to array for processing
                    
                    if (filesList.length > 0) {
                        hasFiles = true;
                        
                        // Create project section with improved styling
                        const projectSection = document.createElement('div');
                        projectSection.className = 'project-section';
                        projectSection.style.marginBottom = '30px';
                        projectSection.style.border = '1px solid #dee2e6';
                        projectSection.style.borderRadius = '8px';
                        projectSection.style.overflow = 'hidden';
                        
                        // Add project header with improved styling
                        const projectHeader = document.createElement('div');
                        projectHeader.className = 'project-header';
                        projectHeader.style.padding = '15px';
                        projectHeader.style.backgroundColor = '#f8f9fa';
                        projectHeader.style.borderBottom = '2px solid #dee2e6';
                        projectHeader.innerHTML = `
                            <h3 style="margin: 0; color: #333; display: flex; align-items: center;">
                                <span style="flex: 1;">${projectData.projectTitle || projectData.projectId}</span>
                                <span style="font-size: 0.8em; color: #6c757d; font-weight: normal;">
                                    ${filesList.length} file${filesList.length !== 1 ? 's' : ''}
                                </span>
                            </h3>
                        `;
                        projectSection.appendChild(projectHeader);
                        
                        // Create a container for files with padding
                        const filesContainer = document.createElement('div');
                        filesContainer.style.padding = '15px';
                        
                        // Add files for this project
                        filesList.forEach(file => {
                            const fileItem = document.createElement('div');
                            fileItem.className = 'uploaded-file-item';
                            fileItem.style.backgroundColor = '#ffffff';
                            fileItem.style.border = '1px solid #e9ecef';
                            fileItem.style.borderRadius = '6px';
                            fileItem.style.padding = '15px';
                            fileItem.style.marginBottom = '10px';
                            
                            const uploadDate = file.uploadedAt ? new Date(file.uploadedAt.toDate()).toLocaleDateString() : 'Unknown date';
                            const fileSize = formatFileSize(file.size || 0);
                            const sharedWith = file.accessEmails ? file.accessEmails.filter(email => email !== file.uploaderEmail).join(', ') : '';
                            
                            fileItem.innerHTML = `
                                <div style="margin-bottom: 10px;">
                                    <div class="file-name" style="font-weight: 500; font-size: 1.1em; color: #333;">
                                        ${file.name}
                                    </div>
                                    <div style="color: #6c757d; font-size: 0.9em; margin-top: 5px;">
                                        <div><strong>Size:</strong> ${fileSize}</div>
                                        <div><strong>Uploaded:</strong> ${uploadDate}</div>
                                        <div><strong>Path:</strong> <span style="font-family: monospace; background: #f8f9fa; padding: 2px 4px; border-radius: 3px;">${file.path || 'N/A'}</span></div>
                                        ${file.uploaderEmail ? `<div><strong>Uploaded by:</strong> ${file.uploaderEmail}</div>` : ''}
                                        ${sharedWith ? `<div><strong>Shared with:</strong> ${sharedWith}</div>` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-primary rounded-pill btn-sm" onclick="downloadBase64File('${file.fileId}', '${file.name}', '${file.type}')">Download</button>
                                    ${user.uid === file.uploadedBy ? 
                                        `<button class="btn btn-outline-danger rounded-pill btn-sm" onclick="deleteFileFromProject('${projectDoc.id}', '${file.fileId}')">Delete</button>` 
                                        : ''}
                                </div>
                            `;
                            
                            filesContainer.appendChild(fileItem);
                        });
                        
                        projectSection.appendChild(filesContainer);
                        uploadedFiles.appendChild(projectSection);
                    }
                }
                
                if (!hasFiles) {
                    uploadedFiles.innerHTML = '<p class="p-3 text-muted">No files found in any project</p>';
                }
                
            } catch (error) {
                loading.style.display = 'none';
                debugInfo.innerHTML += '\nError loading files: ' + error.message;
                showError('Error loading files: ' + error.message);
            }
        }
        
        // Function to delete a file from a project
        async function deleteFileFromProject(projectId, fileId) {
            if (!confirm('Are you sure you want to delete this file?')) {
                return;
            }
            
            try {
                loading.style.display = 'block';
                const db = firebase.firestore();
                const projectRef = db.collection('uploadedFiles').doc(projectId);
                
                // Delete the specific file from the files object
                await projectRef.update({
                    [`files.${fileId}`]: firebase.firestore.FieldValue.delete()
                });
                
                loading.style.display = 'none';
                showSuccess('File deleted successfully');
                
                // Refresh the display
                loadUserDocuments(firebase.auth().currentUser.uid);
                
            } catch (error) {
                loading.style.display = 'none';
                debugInfo.innerHTML += '\nError deleting file: ' + error.message;
                showError('Error deleting file: ' + error.message);
            }
        }
        
        // Event Listeners
        selectFileBtn.addEventListener('click', function() {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', function(e) {
            handleFiles(e.target.files);
        });
        
        // Drag and drop handlers
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            uploadArea.classList.add('highlight');
        }
        
        function unhighlight() {
            uploadArea.classList.remove('highlight');
        }
        
        uploadArea.addEventListener('drop', function(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        });
        
        // Handle selected files
        function handleFiles(files) {
            // Convert FileList to array
            const filesArray = Array.from(files);
            
            // Add each file to the selectedFiles array if not already there
            filesArray.forEach(file => {
                // Check for duplicates
                if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                    selectedFiles.push(file);
                }
            });

            // Update UI
            updateFileList();
            
            // Enable upload and clear buttons
            uploadBtn.disabled = selectedFiles.length === 0;
            clearBtn.disabled = selectedFiles.length === 0;
        }
        
        // Update file list UI
        function updateFileList() {
            fileList.innerHTML = '';
            
            if (selectedFiles.length === 0) {
                fileList.style.display = 'none';
                return;
            } else {
                fileList.style.display = 'block';
            }
            
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item mb-2 p-3 rounded';
                
                const fileSize = formatFileSize(file.size);
                
                fileItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="me-3">
                            <div class="file-name fw-bold">${file.name}</div>
                            <div class="file-size text-muted small">${fileSize}</div>
                            <div class="progress-container mt-2">
                            <div class="progress-bar"></div>
                        </div>
                    </div>
                        <button class="btn btn-sm btn-outline-danger rounded-pill remove-btn">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                `;
                
                fileList.appendChild(fileItem);
                
                // Add remove button event listener
                fileItem.querySelector('.remove-btn').addEventListener('click', function() {
                    selectedFiles.splice(index, 1);
                    updateFileList();
                    
                    // Disable buttons if no files
                    uploadBtn.disabled = selectedFiles.length === 0;
                    clearBtn.disabled = selectedFiles.length === 0;
                });
            });
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Clear files button
        clearBtn.addEventListener('click', function() {
            selectedFiles = [];
            updateFileList();
            uploadBtn.disabled = true;
            clearBtn.disabled = true;
        });
        
        // Upload files button
        uploadBtn.addEventListener('click', function() {
            uploadFiles();
        });
        
        // Upload files function - Modified to handle both direct and SDK uploads
        function uploadFiles() {
            if (selectedFiles.length === 0) {
                return;
            }
            
            // Disable the upload button
            uploadBtn.disabled = true;
            clearBtn.disabled = true;
            
            // Show loading
            loading.style.display = 'block';
            
            // Get current user
            const user = firebase.auth().currentUser;
            
            if (!user) {
                showError('No user logged in. Please refresh the page.');
                loading.style.display = 'none';
                return;
            }
            
            // Get selected project
            const projectSelect = document.getElementById('projectSelect');
            const selectedProject = projectSelect.value;
            
            // Reference to progress bars
            const progressContainers = document.querySelectorAll('.progress-container');
            const progressBars = document.querySelectorAll('.progress-bar');
            
            // Show progress bars
            progressContainers.forEach(container => {
                container.style.display = 'block';
            });
            
            // Track completed uploads
            let completedUploads = 0;
            let failedUploads = 0;
            
            // Reset upload tasks array
            uploadTasks = [];
            
            // Check which upload method is selected
            const useBase64Upload = document.getElementById('base64UploadRadio').checked;
            const useDirectUpload = document.getElementById('directUploadRadio').checked;
            const useSDKUpload = document.getElementById('sdkUploadRadio').checked;
            
            // Upload each file
            selectedFiles.forEach((file, index) => {
                // Generate a unique file name to avoid overwrites
                const timestamp = Date.now();
                const uniqueFileName = `${timestamp}-${file.name}`;
                const filePath = `${selectedProject}/${user.uid}/${uniqueFileName}`;
                
                if (useBase64Upload) {
                    // Use base64 upload method (most compatible)
                    base64UploadFile(file, filePath, index, progressBars)
                        .catch((error) => {
                            failedUploads++;
                            checkAllUploadsComplete();
                        });
                } else if (useDirectUpload) {
                    // Use direct upload method to bypass CORS
                    directUploadFile(file, filePath, index, progressBars);
                } else if (useSDKUpload) {
                    // Use Firebase Storage SDK
                    sdkUploadFile(file, filePath, index, progressBars);
                }
            });
            
            // Direct upload method using fetch API
            async function directUploadFile(file, filePath, index, progressBars) {
                try {
                    debugInfo.innerHTML += `\nDirect upload starting for: ${file.name}`;
                    
                    // Get the Firebase auth token
                    const token = await user.getIdToken();
                    
                    // Create URL for upload
                    const uploadUrl = `https://firebasestorage.googleapis.com/v0/b/${firebaseConfig.storageBucket}/o?name=${encodeURIComponent(filePath)}`;
                    
                    // Set up fetch headers
                    const headers = new Headers({
                        'Content-Type': file.type || 'application/octet-stream',
                        'Authorization': `Firebase ${token}`
                    });
                    
                    // Upload the file
                    const response = await fetch(uploadUrl, {
                        method: 'POST',
                        headers: headers,
                        body: file,
                    });
                    
                    // Check if upload was successful
                    if (response.ok) {
                        const data = await response.json();
                        debugInfo.innerHTML += `\nDirect upload successful for: ${file.name}`;
                        progressBars[index].style.width = '100%';
                        // Save file details to Firestore after successful upload
                        await saveFileDetailsToFirestore(file, filePath);
                        completedUploads++;
                    } else {
                        const errorText = await response.text();
                        throw new Error(`Upload failed with status ${response.status}: ${errorText}`);
                    }
                } catch (error) {
                    debugInfo.innerHTML += `\nDirect upload error for ${file.name}: ${error.message}`;
                    failedUploads++;
                }
                
                // Check if all uploads are complete
                checkAllUploadsComplete();
            }
            
            // New Base64 Upload method - works around CORS entirely
            async function base64UploadFile(file, filePath, index, progressBars) {
                return new Promise((resolve, reject) => {
                    // Validate file size - Firestore has limits
                    const maxSizeMB = 10;
                    if (file.size > maxSizeMB * 1024 * 1024) {
                        showError(`File ${file.name} is too large for Base64 upload (max ${maxSizeMB}MB). Try a different upload method.`);
                        reject(new Error(`File too large for Base64 upload (max ${maxSizeMB}MB)`));
                        return;
                    }

                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    
                    reader.onprogress = (event) => {
                        if (event.lengthComputable) {
                            // This is just the read progress, not upload progress
                            const progress = (event.loaded / event.total) * 50; // Use half the progress bar for reading
                            progressBars[index].style.width = progress + '%';
                        }
                    };
                    
                    reader.onerror = () => {
                        reject(new Error("Failed to read file"));
                    };
                    
                    reader.onload = async () => {
                        try {
                            debugInfo.innerHTML += `\nFile read complete, size: ${Math.round(reader.result.length / 1024)} KB`;
                            // The result is a data URL like: data:application/pdf;base64,JVBERi0xLjMK...
                            // We need to extract just the base64 part
                            const base64Content = reader.result.split(',')[1];
                            
                            // Get the Firebase database reference
                            const db = firebase.firestore();
                            
                            // Prepare metadata
                            const metadata = {
                                name: file.name,
                                contentType: file.type || 'application/octet-stream',
                                size: file.size,
                                storagePath: filePath,
                                uploadedBy: user.uid,
                                uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                // Store a sample of the beginning of base64 for verification (first 100 chars)
                                base64Sample: base64Content.substring(0, 100)
                            };
                            
                            // Use a batched write to handle large files
                            // Firestore has a 1MB document size limit, so we need to split the file
                            const chunkSize = 800000; // slightly less than 1MB after accounting for metadata
                            const numChunks = Math.ceil(base64Content.length / chunkSize);
                            
                            debugInfo.innerHTML += `\nSplitting file into ${numChunks} chunks`;
                            
                            // Create a batch for the metadata document
                            const metadataBatch = db.batch();
                            
                            // Create a unique document ID for this file
                            const fileDocId = `file_${Date.now()}_${Math.random().toString(36).substring(2, 10)}`;
                            const fileDocRef = db.collection('fileUploads').doc(fileDocId);
                            
                            // Set the metadata
                            metadata.chunks = numChunks;
                            metadata.fileId = fileDocId;
                            metadataBatch.set(fileDocRef, metadata);
                            
                            // Commit the metadata batch
                            await metadataBatch.commit();
                            
                            debugInfo.innerHTML += `\nMetadata saved, uploading chunks...`;
                            progressBars[index].style.width = '60%';
                            
                            try {
                                // Upload each chunk with progress
                                for (let i = 0; i < numChunks; i++) {
                                    const chunkBatch = db.batch();
                                    const start = i * chunkSize;
                                    const end = Math.min(start + chunkSize, base64Content.length);
                                    const chunk = base64Content.substring(start, end);
                                    
                                    // Create a chunk document
                                    const chunkDocRef = db.collection('fileChunks').doc(`${fileDocId}_chunk_${i}`);
                                    chunkBatch.set(chunkDocRef, {
                                        fileId: fileDocId,
                                        chunkIndex: i,
                                        data: chunk,
                                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                    
                                    await chunkBatch.commit();
                                    
                                    // Update progress (60% to 100% based on chunk progress)
                                    const progress = 60 + ((i + 1) / numChunks) * 40;
                                    progressBars[index].style.width = progress + '%';
                                    
                                    debugInfo.innerHTML += `\nUploaded chunk ${i+1}/${numChunks}`;
                                }
                                
                                debugInfo.innerHTML += `\nBase64 upload successful for: ${file.name}`;
                                progressBars[index].style.width = '100%';
                                completedUploads++;
                                resolve();
                            } catch (chunkError) {
                                // If chunk upload fails, try to clean up partial uploads
                                debugInfo.innerHTML += `\nError uploading chunks: ${chunkError.message}`;
                                debugInfo.innerHTML += `\nCleaning up partial upload...`;
                                
                                // Delete metadata
                                try {
                                    await fileDocRef.delete();
                                    // Delete any chunks that were uploaded
                                    for (let j = 0; j < i; j++) {
                                        await db.collection('fileChunks').doc(`${fileDocId}_chunk_${j}`).delete();
                                    }
                                    debugInfo.innerHTML += `\nCleanup complete for failed upload`;
                                } catch (cleanupError) {
                                    debugInfo.innerHTML += `\nCleanup failed: ${cleanupError.message}`;
                                }
                                
                                reject(chunkError);
                            }
                        } catch (error) {
                            debugInfo.innerHTML += `\nBase64 upload error for ${file.name}: ${error.message}`;
                            reject(error);
                        }
                    };
                });
            }
            
            // Firebase SDK upload method (original method)
            function sdkUploadFile(file, filePath, index, progressBars) {
                // Create a storage reference
                const fileRef = storageRef.child(filePath);
                
                // Create metadata
                const metadata = {
                    contentType: file.type,
                    customMetadata: {
                        'originalName': file.name,
                        'uploadedBy': user.uid
                    }
                };
                
                // Upload the file
                const uploadTask = fileRef.put(file, metadata);
                
                // Add to upload tasks array
                uploadTasks.push(uploadTask);
                
                // Monitor upload progress
                uploadTask.on('state_changed', 
                    // Progress
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressBars[index].style.width = progress + '%';
                        
                        debugInfo.innerHTML += `\nUpload progress for ${file.name}: ${Math.round(progress)}%`;
                    },
                    // Error
                    (error) => {
                        debugInfo.innerHTML += `\nError uploading ${file.name}: ${error.message}`;
                        failedUploads++;
                        checkAllUploadsComplete();
                    },
                    // Complete
                    async () => {
                        debugInfo.innerHTML += `\nUpload complete for ${file.name}`;
                        // Save file details to Firestore after successful upload
                        await saveFileDetailsToFirestore(file, filePath);
                        completedUploads++;
                        checkAllUploadsComplete();
                    }
                );
            }
            
            // Check if all uploads are complete
            function checkAllUploadsComplete() {
                if (completedUploads + failedUploads === selectedFiles.length) {
                    // All uploads finished
                    loading.style.display = 'none';
                    
                    if (failedUploads > 0) {
                        if (completedUploads > 0) {
                            showSuccess(`${completedUploads} files uploaded successfully. ${failedUploads} files failed.`);
                        } else {
                            showError('All uploads failed. Please try again.');
                        }
                    } else {
                        showSuccess('All files uploaded successfully!');
                        
                        // Clear the selected files
                        selectedFiles = [];
                        updateFileList();
                    }
                    
                    // Try to reload files, but handle failures gracefully
                    try {
                        loadUserDocuments(user.uid);
                    } catch (error) {
                        debugInfo.innerHTML += '\nError reloading files: ' + error.message;
                        uploadedFiles.innerHTML = '<p style="padding: 10px; color: #6c757d;">Files uploaded but cannot display due to CORS restrictions. Refresh the page to try again.</p>';
                    }
                    
                    // Re-enable buttons
                    uploadBtn.disabled = true;
                    clearBtn.disabled = true;
                }
            }
        }
        
        // Show success alert
        function showSuccess(message) {
            successAlert.textContent = message;
            successAlert.style.display = 'block';
            errorAlert.style.display = 'none';
            
            // Hide after 5 seconds
            setTimeout(() => {
                successAlert.style.display = 'none';
            }, 5000);
        }
        
        // Show error alert
        function showError(message) {
            errorAlert.textContent = message;
            errorAlert.style.display = 'block';
            successAlert.style.display = 'none';
            
            // Hide after 5 seconds
            setTimeout(() => {
                errorAlert.style.display = 'none';
            }, 5000);
        }

        // Toggle debug info
        toggleDebugBtn.addEventListener('click', function() {
            if (debugInfo.style.display === 'none') {
                debugInfo.style.display = 'block';
            } else {
                debugInfo.style.display = 'none';
            }
        });

        // Add buttons to the uploaded files section to download files
        function addDownloadAllButton() {
            // Remove existing button if present
            const existingBtn = document.getElementById('downloadAllBtn');
            if (existingBtn) {
                existingBtn.remove();
            }
            
            // Add a "Show Uploads from Base64" button
            const downloadBtn = document.createElement('button');
            downloadBtn.id = 'downloadAllBtn';
            downloadBtn.className = 'btn';
            downloadBtn.style.marginTop = '15px';
            downloadBtn.style.backgroundColor = '#28a745';
            downloadBtn.textContent = 'View Base64 Uploads';
            downloadBtn.addEventListener('click', listBase64Uploads);
            
            // Add to the uploads section
            document.querySelector('.uploads-section').appendChild(downloadBtn);
        }
        
        // Function to list and download base64 uploads
        async function listBase64Uploads() {
            const user = firebase.auth().currentUser;
            if (!user) {
                showError('No user logged in. Please refresh the page.');
                return;
            }
            
            try {
                loading.style.display = 'block';
                const db = firebase.firestore();
                
                // Query for files uploaded by this user
                const snapshot = await db.collection('fileUploads')
                    .where('uploadedBy', '==', user.uid)
                    .orderBy('uploadedAt', 'desc')
                    .get();
                
                loading.style.display = 'none';
                
                if (snapshot.empty) {
                    uploadedFiles.innerHTML = '<p style="padding: 10px; color: #6c757d;">No base64 uploads found</p>';
                    return;
                }
                
                uploadedFiles.innerHTML = '';
                
                // Process each file metadata
                snapshot.forEach(doc => {
                    const fileData = doc.data();
                    const fileItem = document.createElement('div');
                    fileItem.className = 'uploaded-file-item';
                    
                    // Format date
                    const uploadDate = fileData.uploadedAt ? new Date(fileData.uploadedAt.toDate()).toLocaleDateString() : 'Unknown date';
                    
                    // Format file size
                    const fileSize = formatFileSize(fileData.size || 0);
                    
                    fileItem.innerHTML = `
                        <div>
                            <div class="file-name">${fileData.name}</div>
                            <div style="color: #6c757d; font-size: 0.9em;">
                                ${fileSize} • Uploaded on ${uploadDate}
                            </div>
                        </div>
                        <div>
                            <button class="btn download-file-btn" data-file-id="${fileData.fileId}">Download</button>
                            <button class="btn btn-secondary delete-base64-btn" data-file-id="${fileData.fileId}">Delete</button>
                        </div>
                    `;
                    
                    uploadedFiles.appendChild(fileItem);
                    
                    // Add download button event listener
                    fileItem.querySelector('.download-file-btn').addEventListener('click', function() {
                        const fileId = this.getAttribute('data-file-id');
                        downloadBase64File(fileId, fileData.name, fileData.contentType);
                    });
                    
                    // Add delete button event listener
                    fileItem.querySelector('.delete-base64-btn').addEventListener('click', function() {
                        const fileId = this.getAttribute('data-file-id');
                        deleteBase64File(fileId, fileItem);
                    });
                });
            } catch (error) {
                loading.style.display = 'none';
                debugInfo.innerHTML += '\nError loading base64 files: ' + error.message;
                showError('Error loading files: ' + error.message);
            }
        }
        
        // Function to download a base64 file
        async function downloadBase64File(fileId, fileName, contentType) {
            try {
                loading.style.display = 'block';
                const db = firebase.firestore();
                
                // Get the metadata first
                const metadataDoc = await db.collection('fileUploads').doc(fileId).get();
                
                if (!metadataDoc.exists) {
                    throw new Error('File metadata not found');
                }
                
                const metadata = metadataDoc.data();
                const numChunks = metadata.chunks || 0;
                
                debugInfo.innerHTML += `\nDownloading ${fileName} in ${numChunks} chunks...`;
                
                // Initialize an array to hold all chunks
                let base64Chunks = [];
                
                // Get all chunks
                for (let i = 0; i < numChunks; i++) {
                    const chunkDoc = await db.collection('fileChunks').doc(`${fileId}_chunk_${i}`).get();
                    
                    if (!chunkDoc.exists) {
                        throw new Error(`Chunk ${i} not found`);
                    }
                    
                    const chunkData = chunkDoc.data();
                    base64Chunks.push(chunkData.data);
                    
                    debugInfo.innerHTML += `\nDownloaded chunk ${i+1}/${numChunks}`;
                }
                
                // Combine all chunks into a single base64 string
                const base64Data = base64Chunks.join('');
                
                // Create a data URL
                const dataUrl = `data:${contentType || 'application/octet-stream'};base64,${base64Data}`;
                
                // Create a link and download
                const downloadLink = document.createElement('a');
                downloadLink.href = dataUrl;
                downloadLink.download = fileName || 'download';
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                debugInfo.innerHTML += `\nDownload complete for ${fileName}`;
                loading.style.display = 'none';
                
            } catch (error) {
                loading.style.display = 'none';
                debugInfo.innerHTML += '\nError downloading file: ' + error.message;
                showError('Error downloading file: ' + error.message);
            }
        }
        
        // Function to delete a base64 file
        async function deleteBase64File(fileId, fileItem) {
            if (!confirm('Are you sure you want to delete this file?')) {
                return;
            }
            
            try {
                loading.style.display = 'block';
                const db = firebase.firestore();
                
                // Get the metadata first
                const metadataDoc = await db.collection('fileUploads').doc(fileId).get();
                
                if (!metadataDoc.exists) {
                    throw new Error('File metadata not found');
                }
                
                const metadata = metadataDoc.data();
                const numChunks = metadata.chunks || 0;
                
                debugInfo.innerHTML += `\nDeleting ${metadata.name} with ${numChunks} chunks...`;
                
                // Delete metadata
                await db.collection('fileUploads').doc(fileId).delete();
                
                // Delete all chunks
                for (let i = 0; i < numChunks; i++) {
                    await db.collection('fileChunks').doc(`${fileId}_chunk_${i}`).delete();
                    debugInfo.innerHTML += `\nDeleted chunk ${i+1}/${numChunks}`;
                }
                
                // Remove from UI
                fileItem.remove();
                
                // If no more files, show the empty message
                if (uploadedFiles.children.length === 0) {
                    uploadedFiles.innerHTML = '<p style="padding: 10px; color: #6c757d;">No uploaded documents yet</p>';
                }
                
                loading.style.display = 'none';
                showSuccess('File deleted successfully');
                
            } catch (error) {
                loading.style.display = 'none';
                debugInfo.innerHTML += '\nError deleting file: ' + error.message;
                showError('Error deleting file: ' + error.message);
            }
        }

        // Add Firebase Collection Status Check
        const checkCollectionsBtn = document.createElement('button');
        checkCollectionsBtn.innerText = 'Check Firestore Collections';
        checkCollectionsBtn.style.backgroundColor = '#17a2b8';
        checkCollectionsBtn.style.marginTop = '15px';
        checkCollectionsBtn.className = 'btn';
        checkCollectionsBtn.addEventListener('click', async function() {
            try {
                debugInfo.style.display = 'block';
                debugInfo.innerHTML += '\n\nChecking Firestore collections...';
                
                const db = firebase.firestore();
                
                // Check if collections exist
                const fileUploadsSnapshot = await db.collection('fileUploads').limit(1).get();
                const fileChunksSnapshot = await db.collection('fileChunks').limit(1).get();
                
                debugInfo.innerHTML += `\nfileUploads collection exists: ${!fileUploadsSnapshot.empty}`;
                debugInfo.innerHTML += `\nfileChunks collection exists: ${!fileChunksSnapshot.empty}`;
                
                // Get counts
                if (!fileUploadsSnapshot.empty) {
                    const countQuery = await db.collection('fileUploads').count().get();
                    debugInfo.innerHTML += `\nNumber of files: ${countQuery.data().count}`;
                }
                
                if (!fileChunksSnapshot.empty) {
                    const countQuery = await db.collection('fileChunks').count().get();
                    debugInfo.innerHTML += `\nNumber of chunks: ${countQuery.data().count}`;
                }
                
                debugInfo.innerHTML += '\nFirestore check complete!';
            } catch (error) {
                debugInfo.innerHTML += `\nError checking Firestore: ${error.message}`;
                
                if (error.message.includes('count')) {
                    debugInfo.innerHTML += `\nNote: The 'count()' function requires a Firestore billing plan upgrade.`;
                }
            }
        });
        document.querySelector('.debug-section').appendChild(checkCollectionsBtn);
        
        // Function to save file details to Firestore
        async function saveFileDetailsToFirestore(file, filePath) {
            const db = firebase.firestore();
            const user = firebase.auth().currentUser;
            const projectSelect = document.getElementById('projectSelect');
            const selectedProject = projectSelect.value;
            const selectedProjectTitle = projectSelect.options[projectSelect.selectedIndex].text;
            
            // Create an array of access emails that includes the uploader
            const accessEmails = [...new Set([user.email, ...sharedAccessEmails])].filter(Boolean);
            
            // Create a document reference with the project ID
            const projectDocRef = db.collection('uploadedFiles').doc(selectedProject);
            
            // Get the current timestamp
            const timestamp = firebase.firestore.FieldValue.serverTimestamp();
            
            // Generate a unique file ID
            const fileId = `${Date.now()}_${Math.random().toString(36).substring(2, 10)}`;
            
            try {
                // Get the full storage path
                const storagePath = `gs://${firebaseConfig.storageBucket}/${filePath}`;
                
                // Create the file data object with storage path
                const fileData = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    path: storagePath, // Store the complete storage path
                    uploadedBy: user.uid,
                    uploaderEmail: user.email,
                    uploadedAt: timestamp,
                    accessEmails: accessEmails,
                    fileId: fileId,
                    projectId: selectedProject,
                    projectTitle: selectedProjectTitle
                };
                
                // First, check if the project document exists
                const projectDoc = await projectDocRef.get();
                
                if (!projectDoc.exists) {
                    // If project document doesn't exist, create it with project title
                    await projectDocRef.set({
                        projectId: selectedProject,
                        projectTitle: selectedProjectTitle,
                        createdAt: timestamp,
                        createdBy: user.uid,
                        files: {
                            [fileId]: fileData // Initialize with the first file
                        }
                    });
                } else {
                    // Update the project document by adding the new file to the files object
                    await projectDocRef.update({
                        [`files.${fileId}`]: fileData
                    });
                }
                
                debugInfo.innerHTML += `\nFile details saved to Firestore for: ${file.name}`;
                debugInfo.innerHTML += `\nStorage path: ${storagePath}`;
                debugInfo.innerHTML += `\nIn project: ${selectedProjectTitle} (${selectedProject})`;
                debugInfo.innerHTML += `\nAccess granted to: ${accessEmails.join(', ')}`;
                
                // Refresh the display to show the new file
                await loadUserDocuments(user.uid);
                
            } catch (error) {
                debugInfo.innerHTML += `\nError saving file details to Firestore: ${error.message}`;
                showError(`Error saving file details: ${error.message}`);
            }
        }

        // Initialize shared access emails array
        let sharedAccessEmails = [];

        // Add email to access list
        document.getElementById('addEmailBtn').addEventListener('click', function() {
            const emailInput = document.getElementById('accessEmails');
            const emails = emailInput.value.split(',').map(e => e.trim()).filter(e => e);
            
            emails.forEach(email => {
                if (email && !sharedAccessEmails.includes(email)) {
                    sharedAccessEmails.push(email);
                    addEmailChip(email);
                }
            });
            
            emailInput.value = '';
            updateDebugInfo();
        });

        function addEmailChip(email) {
            const emailList = document.getElementById('emailList');
            const chip = document.createElement('div');
            chip.className = 'email-chip';
            
            chip.innerHTML = `
                <span>${email}</span>
                <button class="remove-email" style="background: none; border: none; margin-left: 5px; cursor: pointer; color: #dc3545;">&times;</button>
            `;
            
            chip.querySelector('.remove-email').addEventListener('click', function() {
                const index = sharedAccessEmails.indexOf(email);
                if (index > -1) {
                    sharedAccessEmails.splice(index, 1);
                    chip.remove();
                    updateDebugInfo();
                }
            });
            
            emailList.appendChild(chip);
        }

        function updateDebugInfo() {
            debugInfo.innerHTML += '\nShared access emails: ' + sharedAccessEmails.join(', ');
        }

        // Show/hide emulator settings
        document.getElementById('useEmulatorCheckbox').addEventListener('change', function() {
            document.getElementById('emulatorSettings').style.display = this.checked ? 'flex' : 'none';
            
            if (this.checked) {
                const host = document.getElementById('emulatorHost').value || 'localhost';
                const port = document.getElementById('emulatorPort').value || '9199';
                
                try {
                    firebase.storage().useEmulator(host, parseInt(port));
                    debugInfo.innerHTML += `\nConnected to Storage emulator at ${host}:${port}`;
                } catch (error) {
                    debugInfo.innerHTML += `\nError connecting to emulator: ${error.message}`;
                }
            }
        });

        // === Grant Access to Existing Files Functionality ===
        
        // Elements for grant access section
        const existingProjectSelect = document.getElementById('existingProjectSelect');
        const existingFileSelect = document.getElementById('existingFileSelect');
        const loadFilesBtn = document.getElementById('loadFilesBtn');
        const grantAccessEmails = document.getElementById('grantAccessEmails');
        const addGrantEmailBtn = document.getElementById('addGrantEmailBtn');
        const grantEmailList = document.getElementById('grantEmailList');
        const updateAccessBtn = document.getElementById('updateAccessBtn');
        
        // Variable to store emails for granting access to existing files
        let grantAccessEmailsList = [];
        // Variable to store the currently selected file data
        let selectedFileData = null;
        
        // Load the files for a selected project
        loadFilesBtn.addEventListener('click', function() {
            loadFilesForProject(existingProjectSelect.value);
        });
        
        // Handle project selection change
        existingProjectSelect.addEventListener('change', function() {
            // Reset the file select dropdown
            existingFileSelect.innerHTML = '<option value="">Select a project first</option>';
            // Disable the update access button
            updateAccessBtn.disabled = true;
        });
        
        // Handle file selection change
        existingFileSelect.addEventListener('change', function() {
            const fileId = this.value;
            if (fileId) {
                // Load the selected file's current access list
                loadSelectedFileAccess(existingProjectSelect.value, fileId);
                // Enable the update access button
                updateAccessBtn.disabled = false;
            } else {
                // Disable the update access button if no file is selected
                updateAccessBtn.disabled = true;
                // Clear the grant email list
                grantEmailList.innerHTML = '';
                grantAccessEmailsList = [];
            }
        });
        
        // Load files for a project
        async function loadFilesForProject(projectId) {
            if (!projectId) return;
            
            try {
                loading.style.display = 'block';
                
                const db = firebase.firestore();
                const projectDoc = await db.collection('uploadedFiles').doc(projectId).get();
                
                if (!projectDoc.exists) {
                    showError(`Project ${projectId} not found.`);
                    loading.style.display = 'none';
                    return;
                }
                
                const projectData = projectDoc.data();
                const files = projectData.files || {};
                
                // Clear the file select dropdown
                existingFileSelect.innerHTML = '';
                
                if (Object.keys(files).length === 0) {
                    existingFileSelect.innerHTML = '<option value="">No files in this project</option>';
                } else {
                    // Add a default option
                    existingFileSelect.innerHTML = '<option value="">Select a file</option>';
                    
                    // Add each file to the dropdown
                    Object.entries(files).forEach(([fileId, fileData]) => {
                        const option = document.createElement('option');
                        option.value = fileId;
                        option.textContent = fileData.name;
                        existingFileSelect.appendChild(option);
                    });
                }
                
                loading.style.display = 'none';
                
            } catch (error) {
                loading.style.display = 'none';
                debugInfo.innerHTML += `\nError loading files for project: ${error.message}`;
                showError(`Error loading files: ${error.message}`);
            }
        }
        
        // Load the access list for a selected file
        async function loadSelectedFileAccess(projectId, fileId) {
            if (!projectId || !fileId) return;
            
            try {
                loading.style.display = 'block';
                
                const db = firebase.firestore();
                const projectDoc = await db.collection('uploadedFiles').doc(projectId).get();
                
                if (!projectDoc.exists) {
                    showError(`Project ${projectId} not found.`);
                    loading.style.display = 'none';
                    return;
                }
                
                const projectData = projectDoc.data();
                const fileData = projectData.files?.[fileId];
                
                if (!fileData) {
                    showError(`File ${fileId} not found in project ${projectId}.`);
                    loading.style.display = 'none';
                    return;
                }
                
                // Store the selected file data for later use
                selectedFileData = fileData;
                
                // Clear the current grant email list
                grantEmailList.innerHTML = '';
                grantAccessEmailsList = [];
                
                // Add the existing access emails to the list
                if (fileData.accessEmails && fileData.accessEmails.length > 0) {
                    fileData.accessEmails.forEach(email => {
                        // Skip the uploader's email as they automatically have access
                        if (email !== fileData.uploaderEmail) {
                            grantAccessEmailsList.push(email);
                            addGrantEmailChip(email);
                        }
                    });
                }
                
                loading.style.display = 'none';
                
            } catch (error) {
                loading.style.display = 'none';
                debugInfo.innerHTML += `\nError loading file access: ${error.message}`;
                showError(`Error loading file access: ${error.message}`);
            }
        }
        
        // Add grant email to the list
        addGrantEmailBtn.addEventListener('click', function() {
            const emails = grantAccessEmails.value.split(',').map(e => e.trim()).filter(e => e);
            
            emails.forEach(email => {
                if (email && !grantAccessEmailsList.includes(email)) {
                    grantAccessEmailsList.push(email);
                    addGrantEmailChip(email);
                }
            });
            
            grantAccessEmails.value = '';
            updateAccessBtn.disabled = false;
        });
        
        // Add an email chip to the grant email list
        function addGrantEmailChip(email) {
            const chip = document.createElement('div');
            chip.className = 'email-chip';
            
            chip.innerHTML = `
                <span>${email}</span>
                <button class="remove-email" style="background: none; border: none; margin-left: 5px; cursor: pointer; color: #dc3545;">&times;</button>
            `;
            
            chip.querySelector('.remove-email').addEventListener('click', function() {
                const index = grantAccessEmailsList.indexOf(email);
                if (index > -1) {
                    grantAccessEmailsList.splice(index, 1);
                    chip.remove();
                }
            });
            
            grantEmailList.appendChild(chip);
        }
        
        // Update access for the selected file
        updateAccessBtn.addEventListener('click', async function() {
            if (!selectedFileData) {
                showError('No file selected.');
                return;
            }
            
            const projectId = existingProjectSelect.value;
            const fileId = existingFileSelect.value;
            
            if (!projectId || !fileId) {
                showError('Please select a project and file.');
                return;
            }
            
            try {
                loading.style.display = 'block';
                
                const db = firebase.firestore();
                const user = firebase.auth().currentUser;
                
                if (!user) {
                    showError('No user logged in. Please refresh the page.');
                    loading.style.display = 'none';
                    return;
                }
                
                // Create an array of access emails that includes the uploader's email
                const accessEmails = [
                    ...new Set([selectedFileData.uploaderEmail, ...grantAccessEmailsList])
                ].filter(Boolean);
                
                // Update the file's access list in Firestore
                await db.collection('uploadedFiles').doc(projectId).update({
                    [`files.${fileId}.accessEmails`]: accessEmails
                });
                
                showSuccess('File access updated successfully!');
                debugInfo.innerHTML += `\nUpdated access for file ${selectedFileData.name} in project ${projectId}`;
                debugInfo.innerHTML += `\nAccess granted to: ${accessEmails.join(', ')}`;
                
                // Refresh the uploaded files display
                await loadUserDocuments(user.uid);
                
                loading.style.display = 'none';
                
            } catch (error) {
                loading.style.display = 'none';
                debugInfo.innerHTML += `\nError updating file access: ${error.message}`;
                showError(`Error updating file access: ${error.message}`);
            }
        });

        // Initialize projects in Firestore
        async function initializeProjects() {
            const db = firebase.firestore();
            const user = firebase.auth().currentUser;
            
            if (!user) return;

            try {
                // Get the projects collection reference
                const projectsRef = db.collection('uploadedFiles');
                
                // Define the projects
                const projects = [
                    { id: 'project-1', title: 'Project 1' },
                    { id: 'project-2', title: 'Project 2' },
                    { id: 'project-3', title: 'Project 3' }
                ];
                
                // Create or update each project document
                for (const project of projects) {
                    const projectDoc = await projectsRef.doc(project.id).get();
                    
                    if (!projectDoc.exists) {
                        await projectsRef.doc(project.id).set({
                            projectId: project.id,
                            projectTitle: project.title,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            createdBy: user.uid,
                            files: {} // Initialize files as an empty object instead of an array
                        });
                        debugInfo.innerHTML += `\nCreated project document: ${project.title}`;
                    }
                }
            } catch (error) {
                debugInfo.innerHTML += `\nError initializing projects: ${error.message}`;
            }
        }

        // Add role-based access control to file-upload.html
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    const userData = userDoc.data();
                    const role = userData?.role || 'user'; // Add default role if none exists

                    // Configure upload permissions based on role
                    const maxFileSize = role === 'founder' ? 100 : (role === 'project manager' ? 50 : 20); // MB
                    const allowedTypes = role === 'intern' ? ['application/pdf'] : 
                                       ['application/pdf', 'application/vnd.openxmlformats-officedocument.presentationml.presentation'];

                    // Update UI based on role if the element exists
                    const maxFileSizeElement = document.getElementById('max-file-size');
                    if (maxFileSizeElement) {
                        maxFileSizeElement.textContent = `Maximum file size: ${maxFileSize}MB`;
                    }
                    
                    // Add role-specific upload restrictions if the element exists
                    const fileInput = document.getElementById('file-input');
                    if (fileInput) {
                        fileInput.setAttribute('accept', allowedTypes.join(','));
                    }

                } catch (error) {
                    console.error('Error fetching user data:', error);
                    debugInfo.innerHTML += '\nError fetching user data: ' + error.message;
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        document.getElementById('doneBtn').addEventListener('click', function() {
            // Add console log for debugging
            console.log('Done button clicked');
            // Use window.location.replace for a more definitive navigation
            window.location.replace('document_viewer.html');
        });
    </script>
</body>
</html> 